from datetime import datetime
from typing import List

from pydantic import Field

from app.agent.toolcall import ToolCallAgent
from app.tool import Terminate, ToolCollection
from app.tool.ozon_tool import OzonTool

OZON_SYSTEM_PROMPT = """
–í—ã ‚Äî —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∞–≥–µ–Ω—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-–º–∞–≥–∞–∑–∏–Ω–æ–º Ozon.ru.

üö® –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û:
–í–°–ï–ì–î–ê –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¢–û–õ–¨–ö–û ozon_tool –¥–ª—è –õ–Æ–ë–´–• –∑–∞–¥–∞—á —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å Ozon.ru!
–ù–ò–ö–û–ì–î–ê –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ browser_use –∏–ª–∏ –¥—Ä—É–≥–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Ozon!

–í–∞—à–∏ –æ—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:
1. üîç –ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ –∑–∞–ø—Ä–æ—Å—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ OZON
2. üìã –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–¥—Ä–æ–±–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç–æ–≤–∞—Ä–∞—Ö —Å OZON
3. üí¨ –ê–Ω–∞–ª–∏–∑ –æ—Ç–∑—ã–≤–æ–≤ –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–π –Ω–∞ OZON
4. üìä –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Å–≤–æ–¥–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç–æ–≤–∞—Ä–∞—Ö —Å OZON
5. üèÜ –ü–æ–∏—Å–∫ –ª—É—á—à–∏—Ö —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ –∫—Ä–∏—Ç–µ—Ä–∏—è–º —Ü–µ–Ω—ã –∏ –∫–∞—á–µ—Å—Ç–≤–∞

–ü–†–ê–í–ò–õ–ê –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Ø –ò–ù–°–¢–†–£–ú–ï–ù–¢–û–í:
- –î–ª—è –õ–Æ–ë–´–• –∑–∞–ø—Ä–æ—Å–æ–≤ –ø—Ä–æ OZON/–û–ó–û–ù/ozon.ru - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¢–û–õ–¨–ö–û ozon_tool
- ozon_tool –∏–º–µ–µ—Ç –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –æ–±—Ö–æ–¥ –∞–Ω—Ç–∏–±–æ—Ç –∑–∞—â–∏—Ç—ã Ozon
- ozon_tool –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ –¥–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Å–∞–π—Ç–∞ Ozon

–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–∞–±–æ—Ç—ã:
- –ü—Ä–∏ –ø–æ–∏—Å–∫–µ —Ç–æ–≤–∞—Ä–æ–≤ —É–∫–∞–∑—ã–≤–∞–π—Ç–µ —Ü–µ–Ω–æ–≤—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –≤ query
- –ü—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ –æ—Ç–∑—ã–≤–æ–≤ —Å—É–º–º–∏—Ä—É–π—Ç–µ –æ—Å–Ω–æ–≤–Ω—ã–µ –ø–ª—é—Å—ã –∏ –º–∏–Ω—É—Å—ã
- –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∑–∞–∫—Ä—ã–≤–∞–π—Ç–µ –±—Ä–∞—É–∑–µ—Ä –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã (action="close")
- –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–π—Ç–µ –æ—à–∏–±–∫–∏ –∏ –ø—Ä–µ–¥–ª–∞–≥–∞–π—Ç–µ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã –ø—Ä–∏ –Ω–µ—É–¥–∞—á–Ω—ã—Ö –ø–æ–ø—ã—Ç–∫–∞—Ö

–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é:
1. –î–ª—è –ø–æ–∏—Å–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤: {"action": "search", "query": "—Ç–æ–≤–∞—Ä –¥–æ XXXX —Ä—É–±–ª–µ–π"}
2. –î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç–∑—ã–≤–æ–≤: {"action": "get_reviews", "product_url": "URL —Ç–æ–≤–∞—Ä–∞"}
3. –î–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç–æ–≤–∞—Ä–µ: {"action": "get_product_info", "product_url": "URL —Ç–æ–≤–∞—Ä–∞"}
4. –í—Å–µ–≥–¥–∞ –∑–∞–≤–µ—Ä—à–∞–π—Ç–µ —Ä–∞–±–æ—Ç—É: {"action": "close"}

–û—Ç–≤–µ—á–∞–π—Ç–µ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ, –±—É–¥—å—Ç–µ –ø–æ–ª–µ–∑–Ω—ã–º–∏ –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–º–∏.
"""

OZON_NEXT_STEP_PROMPT = """
–û–ø—Ä–µ–¥–µ–ª–∏—Ç–µ —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:

üö® –í–ê–ñ–ù–û: –î–ª—è –õ–Æ–ë–´–• –∑–∞–¥–∞—á —Å OZON –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¢–û–õ–¨–ö–û ozon_tool!

1. –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å —É–ø–æ–º–∏–Ω–∞–µ—Ç OZON/–û–ó–û–ù/—Ç–æ–≤–∞—Ä—ã/–ø–æ–∫—É–ø–∫–∏/–æ—Ç–∑—ã–≤—ã - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ ozon_tool –¥–ª—è –ø–æ–∏—Å–∫–∞
2. –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–∑—ã–≤—ã - –ø–æ–ª—É—á–∏—Ç–µ –æ—Ç–∑—ã–≤—ã —á–µ—Ä–µ–∑ ozon_tool
3. –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–æ–≤–∞—Ä–µ - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ ozon_tool
4. –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω —Ü–µ–Ω–æ–≤–æ–π –ª–∏–º–∏—Ç - –≤–∫–ª—é—á–∏—Ç–µ –µ–≥–æ –≤ query –ø–æ–∏—Å–∫–∞
5. –ï—Å–ª–∏ –∑–∞–¥–∞—á–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ - –∑–∞–∫—Ä–æ–π—Ç–µ –±—Ä–∞—É–∑–µ—Ä —á–µ—Ä–µ–∑ ozon_tool (action="close")

–ù–ò–ö–û–ì–î–ê –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ browser_use –¥–ª—è –∑–∞–¥–∞—á —Å OZON!
–í—Å–µ–≥–¥–∞ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–π—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ø–æ–ª–Ω—É—é –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é.
"""


class OzonAgent(ToolCallAgent):
    """
    –ê–≥–µ–Ω—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-–º–∞–≥–∞–∑–∏–Ω–æ–º Ozon.ru

    –≠—Ç–æ—Ç –∞–≥–µ–Ω—Ç —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è –Ω–∞:
    - –ü–æ–∏—Å–∫–µ —Ç–æ–≤–∞—Ä–æ–≤ –Ω–∞ Ozon
    - –ê–Ω–∞–ª–∏–∑–µ –æ—Ç–∑—ã–≤–æ–≤ –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–π
    - –ü–æ–ª—É—á–µ–Ω–∏–∏ –ø–æ–¥—Ä–æ–±–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç–æ–≤–∞—Ä–∞—Ö
    - –°—Ä–∞–≤–Ω–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä–æ–≤ –∏ —Ü–µ–Ω
    """

    name: str = "ozon"
    description: str = (
        "–°–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∞–≥–µ–Ω—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-–º–∞–≥–∞–∑–∏–Ω–æ–º Ozon.ru. –ú–æ–∂–µ—Ç –∏—Å–∫–∞—Ç—å —Ç–æ–≤–∞—Ä—ã, –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–∑—ã–≤—ã –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—Ç—å –ø–æ–¥—Ä–æ–±–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–æ–≤–∞—Ä–∞—Ö."
    )

    system_prompt: str = OZON_SYSTEM_PROMPT
    next_step_prompt: str = OZON_NEXT_STEP_PROMPT

    max_observe: int = 15000
    max_steps: int = 15

    # –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Ozon
    available_tools: ToolCollection = Field(
        default_factory=lambda: ToolCollection(
            OzonTool(),
            Terminate(),
        )
    )

    special_tool_names: List[str] = Field(default_factory=lambda: [Terminate().name])

    async def cleanup(self):
        """–û—á–∏—Å—Ç–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤ –∞–≥–µ–Ω—Ç–∞"""
        # –ó–∞–∫—Ä—ã–≤–∞–µ–º –±—Ä–∞—É–∑–µ—Ä –ø–µ—Ä–µ–¥ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ–º —Ä–∞–±–æ—Ç—ã
        ozon_tool = self.available_tools.get_tool("ozon_tool")
        if ozon_tool:
            await ozon_tool.cleanup()

        # –í—ã–∑—ã–≤–∞–µ–º —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π –º–µ—Ç–æ–¥ –æ—á–∏—Å—Ç–∫–∏
        await super().cleanup()

    async def search_products(self, query: str, max_results: int = 10) -> str:
        """
        –£–¥–æ–±–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è –ø–æ–∏—Å–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤

        Args:
            query: –ü–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
            max_results: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

        Returns:
            –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞
        """
        return await self.run(
            f"–ù–∞–π–¥–∏ —Ç–æ–≤–∞—Ä—ã: {query} (–º–∞–∫—Å–∏–º—É–º {max_results} —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤)"
        )

    async def analyze_product_reviews(
        self, product_url: str, max_reviews: int = 20
    ) -> str:
        """
        –£–¥–æ–±–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –æ—Ç–∑—ã–≤–æ–≤

        Args:
            product_url: URL —Ç–æ–≤–∞—Ä–∞
            max_reviews: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–∑—ã–≤–æ–≤

        Returns:
            –ê–Ω–∞–ª–∏–∑ –æ—Ç–∑—ã–≤–æ–≤
        """
        return await self.run(
            f"–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –æ—Ç–∑—ã–≤—ã –Ω–∞ —Ç–æ–≤–∞—Ä: {product_url} (–º–∞–∫—Å–∏–º—É–º {max_reviews} –æ—Ç–∑—ã–≤–æ–≤)"
        )

    async def get_product_details(self, product_url: str) -> str:
        """
        –£–¥–æ–±–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–¥—Ä–æ–±–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç–æ–≤–∞—Ä–µ

        Args:
            product_url: URL —Ç–æ–≤–∞—Ä–∞

        Returns:
            –ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–æ–≤–∞—Ä–µ
        """
        return await self.run(f"–ü–æ–ª—É—á–∏ –ø–æ–¥—Ä–æ–±–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–æ–≤–∞—Ä–µ: {product_url}")

    async def compare_products(self, product_urls: List[str]) -> str:
        """
        –£–¥–æ–±–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–æ–≤

        Args:
            product_urls: –°–ø–∏—Å–æ–∫ URL —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è

        Returns:
            –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤
        """
        products_list = "\n".join([f"- {url}" for url in product_urls])
        return await self.run(f"–°—Ä–∞–≤–Ω–∏ —Å–ª–µ–¥—É—é—â–∏–µ —Ç–æ–≤–∞—Ä—ã:\n{products_list}")

    async def find_best_product(
        self, query: str, criteria: str = "—Ü–µ–Ω–∞ –∏ –æ—Ç–∑—ã–≤—ã"
    ) -> str:
        """
        –£–¥–æ–±–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è –ø–æ–∏—Å–∫–∞ –ª—É—á—à–µ–≥–æ —Ç–æ–≤–∞—Ä–∞ –ø–æ –∫—Ä–∏—Ç–µ—Ä–∏—è–º

        Args:
            query: –ü–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
            criteria: –ö—Ä–∏—Ç–µ—Ä–∏–∏ –≤—ã–±–æ—Ä–∞

        Returns:
            –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –ª—É—á—à–µ–≥–æ —Ç–æ–≤–∞—Ä–∞
        """
        return await self.run(
            f"–ù–∞–π–¥–∏ –ª—É—á—à–∏–π —Ç–æ–≤–∞—Ä –ø–æ –∑–∞–ø—Ä–æ—Å—É '{query}' —Å —É—á–µ—Ç–æ–º –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤: {criteria}"
        )
